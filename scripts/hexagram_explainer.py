#!/usr/bin/env python3
"""
卦象解釋器 - Hexagram Explainer
基於卦德交互屬性解釋卦象吉凶
"""

import json
import os

# 八卦德性 (白話版)
TRIGRAM_DE = {
    '乾': {'德': '健', '象': '天', '性': '剛健不息', '白話': '一直往前衝、不停'},
    '坤': {'德': '順', '象': '地', '性': '柔順承載', '白話': '穩穩撐住、配合'},
    '震': {'德': '動', '象': '雷', '性': '震動奮發', '白話': '爆發、突然動起來'},
    '巽': {'德': '入', '象': '風', '性': '滲透深入', '白話': '慢慢滲透、深入'},
    '坎': {'德': '陷', '象': '水', '性': '險陷流動', '白話': '危險、陷阱、坑'},
    '離': {'德': '麗', '象': '火', '性': '附麗光明', '白話': '依附、需要靠著'},
    '艮': {'德': '止', '象': '山', '性': '停止阻隔', '白話': '停下來、擋住'},
    '兌': {'德': '說', '象': '澤', '性': '喜悅潤澤', '白話': '開心、說話、交流'},
}

# 交互效應解釋 (白話版)
INTERACTION_EXPLAIN = {
    # 最好的組合 ★★
    ('坤', '震'): ('★★ 最佳組合',
        '下面穩穩撐住，上面往上衝\n'
        '  → 就像種子在土裡發芽往上長\n'
        '  → 公司有穩定後勤 + 前線積極進攻'),
    ('坤', '巽'): ('★★ 很好',
        '下面穩定，上面慢慢深入\n'
        '  → 就像樹根紮穩了，樹枝慢慢長\n'
        '  → 有耐心地一步步推進'),
    ('坎', '乾'): ('★ 不錯',
        '下面雖然危險，但上面夠強\n'
        '  → 就像困難中有高人帶領\n'
        '  → 雖然環境不好，但有實力突破'),
    ('兌', '離'): ('★ 不錯',
        '下面開心，上面光明\n'
        '  → 心情好 + 前途亮\n'
        '  → 喜悅和光明互相照應'),
    ('坤', '兌'): ('★ 不錯',
        '下面配合，上面開心\n'
        '  → 大家都好講話，氣氛好\n'
        '  → 和諧愉快的狀態'),

    # 最差的組合 ✗✗
    ('離', '震'): ('✗✗ 很差',
        '下面想靠穩，上面一直晃\n'
        '  → 就像想好好寫字，桌子一直震\n'
        '  → 需要穩定但環境一直變'),
    ('坤', '坎'): ('✗ 不好',
        '下面配合，但上面是坑\n'
        '  → 好心配合卻掉進陷阱\n'
        '  → 順著走反而有危險'),
    ('艮', '震'): ('✗✗ 很差',
        '下面想停，上面要動\n'
        '  → 就像踩煞車又踩油門\n'
        '  → 自己跟自己打架'),
    ('艮', '艮'): ('✗✗ 最差',
        '下面卡住，上面也卡住\n'
        '  → 車子熄火 + 前面塞車\n'
        '  → 動彈不得，哪都去不了'),
    ('坎', '坎'): ('✗ 很差',
        '下面是坑，上面也是坑\n'
        '  → 欠債 + 借高利貸還債\n'
        '  → 坑裡面還有坑，越陷越深'),

    # 中性疊加
    ('坤', '坤'): ('○ 還可以',
        '上下都配合，大家都好講話\n'
        '  → 團隊每個人都好溝通\n'
        '  → 和諧但缺少推動力'),
    ('乾', '乾'): ('○ 還可以',
        '上下都在衝，動力十足\n'
        '  → 但可能衝過頭\n'
        '  → 需要適時煞車'),
}

# 64卦查找表
HEXAGRAM_LOOKUP = {
    ('乾', '乾'): [0, 0, 0, 0, 0, 0],
    ('乾', '坤'): [1, 1, 0, 0, 1, 0],
    ('乾', '震'): [-1, 0, 1, 1, 1, 1],
    ('乾', '巽'): [0, 1, -1, 1, -1, 1],
    ('乾', '坎'): [1, -1, 1, 1, 1, 0],
    ('乾', '離'): [0, 0, 0, 1, 0, 0],
    ('乾', '艮'): [1, 0, -1, 0, 1, 0],
    ('乾', '兌'): [1, 0, -1, -1, 0, 0],
    ('坤', '乾'): [1, 0, 0, 0, 1, 0],
    ('坤', '坤'): [0, 1, 0, 0, 1, 0],
    ('坤', '震'): [1, 1, 1, 1, 1, 0],
    ('坤', '巽'): [1, 1, 1, 0, 1, 1],
    ('坤', '坎'): [-1, 1, -1, 0, -1, 0],
    ('坤', '離'): [0, 1, 0, 0, 0, 0],
    ('坤', '艮'): [1, 1, 0, 0, 0, -1],
    ('坤', '兌'): [1, 1, 0, 1, 1, 0],
    ('震', '乾'): [0, 0, 1, 1, 1, 0],
    ('震', '坤'): [-1, -1, 0, -1, 1, 0],
    ('震', '震'): [1, 0, -1, 0, 0, 1],
    ('震', '巽'): [0, -1, 0, 1, 1, 1],
    ('震', '坎'): [0, 1, 0, 0, 1, 0],
    ('震', '離'): [0, 0, 1, 0, 1, 0],
    ('震', '艮'): [-1, -1, -1, 1, 1, 1],
    ('震', '兌'): [1, 0, -1, 0, 0, 0],
    ('巽', '乾'): [0, 0, -1, 0, 0, -1],
    ('巽', '坤'): [0, 1, 0, 1, 1, 0],
    ('巽', '震'): [0, 0, 0, 1, 0, 0],
    ('巽', '巽'): [1, 1, -1, 1, -1, 0],
    ('巽', '坎'): [0, -1, -1, 0, 0, 1],
    ('巽', '離'): [0, 1, -1, 1, 0, 1],
    ('巽', '艮'): [1, 0, 0, -1, 1, 0],
    ('巽', '兌'): [0, 1, -1, 1, 0, -1],
    ('坎', '乾'): [1, 1, 0, 0, 1, 1],
    ('坎', '坤'): [1, 1, 0, 1, 1, -1],
    ('坎', '震'): [0, 0, 0, 0, 0, 1],
    ('坎', '巽'): [0, -1, 0, 0, 1, -1],
    ('坎', '坎'): [-1, 0, 0, 0, 0, -1],
    ('坎', '離'): [0, 0, 0, 0, 0, -1],
    ('坎', '艮'): [1, 0, 0, 1, 0, 0],
    ('坎', '兌'): [0, 0, 0, 0, 0, 1],
    ('離', '乾'): [0, 0, 0, 0, 1, 1],
    ('離', '坤'): [1, 1, 0, -1, 1, 1],
    ('離', '震'): [-1, 0, -1, 0, 0, -1],
    ('離', '巽'): [1, 0, 0, 0, 0, 1],
    ('離', '坎'): [0, 1, -1, 1, 1, 0],
    ('離', '離'): [0, 1, -1, 0, 1, 0],
    ('離', '艮'): [0, 0, 0, 1, 0, -1],
    ('離', '兌'): [1, 1, 1, -1, 0, 1],
    ('艮', '乾'): [-1, 1, -1, 1, 0, 1],
    ('艮', '坤'): [-1, 1, -1, 0, 0, 0],
    ('艮', '震'): [-1, 0, -1, 0, 0, -1],
    ('艮', '巽'): [1, 0, 0, 0, 1, 0],
    ('艮', '坎'): [0, 1, 0, 0, 1, 1],
    ('艮', '離'): [0, 1, 0, 1, 1, -1],
    ('艮', '艮'): [1, -1, -1, 0, -1, -1],
    ('艮', '兌'): [-1, 0, 0, 0, 0, -1],
    ('兌', '乾'): [1, 1, 0, 0, 0, -1],
    ('兌', '坤'): [0, 0, 0, 0, 0, 0],
    ('兌', '震'): [0, 1, -1, 0, 1, 1],
    ('兌', '巽'): [1, 0, 0, 0, 0, -1],
    ('兌', '坎'): [1, 0, 0, 1, 0, 0],
    ('兌', '離'): [0, 1, 0, 1, 1, 1],
    ('兌', '艮'): [1, 1, -1, 0, 1, -1],
    ('兌', '兌'): [0, 1, 0, 0, 1, -1],
}


def explain_hexagram(inner: str, outer: str) -> str:
    """生成卦象解釋 (白話版)"""

    inner_info = TRIGRAM_DE[inner]
    outer_info = TRIGRAM_DE[outer]
    positions = HEXAGRAM_LOOKUP.get((inner, outer), [0]*6)

    lines = []
    lines.append(f"\n{'='*50}")
    lines.append(f"【{inner}{outer}卦】 {inner}下{outer}上")
    lines.append(f"{'='*50}")

    # 結構 (白話)
    lines.append(f"\n■ 這個卦的組成")
    lines.append(f"  下面({inner_info['象']}): {inner_info['白話']}")
    lines.append(f"  上面({outer_info['象']}): {outer_info['白話']}")

    # 交互 (白話)
    lines.append(f"\n■ 上下配合的效果")
    key = (inner, outer)
    if key in INTERACTION_EXPLAIN:
        effect, explain = INTERACTION_EXPLAIN[key]
        lines.append(f"  【{effect}】")
        lines.append(f"  {explain}")
    elif inner == outer:
        lines.append(f"  【同卦重疊】")
        if inner in ['艮', '坎']:
            lines.append(f"  同樣的問題疊加 = 更糟")
            if inner == '艮':
                lines.append(f"  → 卡住 + 卡住 = 完全動不了")
            else:
                lines.append(f"  → 危險 + 危險 = 更危險")
        elif inner == '乾':
            lines.append(f"  → 衝 + 衝 = 動力十足，但要注意別衝過頭")
        else:
            lines.append(f"  → 性質純粹，沒有內部衝突")
    else:
        lines.append(f"  【普通組合】")
        lines.append(f"  {inner_info['白話']} + {outer_info['白話']}")
        lines.append(f"  → 沒有特別好或特別差")

    # 六爻 (白話)
    lines.append(f"\n■ 六個位置的好壞")
    pattern = ""
    for i, val in enumerate(positions):
        pos_name = ['初', '二', '三', '四', '五', '上'][i]
        if val == 1:
            pattern += f"[{pos_name}✓]"
        elif val == -1:
            pattern += f"[{pos_name}✗]"
        else:
            pattern += f"[{pos_name}·]"
    lines.append(f"  {pattern}")

    ji = sum(1 for v in positions if v == 1)
    xiong = sum(1 for v in positions if v == -1)
    zhong = 6 - ji - xiong
    lines.append(f"  好的位置: {ji}個 | 壞的位置: {xiong}個 | 普通: {zhong}個")

    # 關鍵爻位 (白話)
    lines.append(f"\n■ 重點位置")
    has_key = False
    if positions[4] == 1:  # Position 5
        lines.append(f"  ★ 第五位(老闆位): 好！領導順利")
        has_key = True
    if positions[4] == -1:
        lines.append(f"  ✗ 第五位(老闆位): 差！領導出問題")
        has_key = True
    if positions[2] == -1:  # Position 3
        lines.append(f"  ✗ 第三位(轉折點): 差！中間卡住")
        has_key = True
    if positions[0] == -1:  # Position 1
        lines.append(f"  ✗ 第一位(起步): 差！一開始就不順")
        has_key = True
    if positions[5] == -1:  # Position 6
        lines.append(f"  ✗ 第六位(結尾): 差！結局不好")
        has_key = True
    if positions[5] == 1:
        lines.append(f"  ★ 第六位(結尾): 好！結局不錯")
        has_key = True
    if not has_key:
        lines.append(f"  沒有特別關鍵的位置")

    # 總評 (白話)
    total = sum(positions)
    lines.append(f"\n■ 總結")
    if total >= 4:
        lines.append(f"  【大吉卦】很好！(分數 {total:+d})")
        lines.append(f"  → 整體運勢很好，放心做")
    elif total >= 2:
        lines.append(f"  【吉卦】不錯 (分數 {total:+d})")
        lines.append(f"  → 整體偏好，但要注意細節")
    elif total >= 0:
        lines.append(f"  【平卦】一般 (分數 {total:+d})")
        lines.append(f"  → 好壞參半，謹慎行事")
    elif total >= -2:
        lines.append(f"  【小凶卦】不太好 (分數 {total:+d})")
        lines.append(f"  → 有些阻礙，最好等等或換方法")
    else:
        lines.append(f"  【凶卦】不好 (分數 {total:+d})")
        lines.append(f"  → 阻礙很多，建議暫停或重新考慮")

    return '\n'.join(lines)


if __name__ == '__main__':
    trigrams = ['乾', '坤', '震', '巽', '坎', '離', '艮', '兌']

    print("卦象解釋器 - 基於卦德交互")
    print("=" * 50)

    # Interactive mode
    while True:
        print("\n輸入下卦和上卦 (如: 坤 震)，或 'q' 退出:")
        user_input = input("> ").strip()

        if user_input.lower() == 'q':
            break

        parts = user_input.split()
        if len(parts) != 2:
            print("請輸入兩個卦名，如: 坤 震")
            continue

        inner, outer = parts[0], parts[1]
        if inner not in trigrams or outer not in trigrams:
            print(f"無效卦名。可用: {', '.join(trigrams)}")
            continue

        print(explain_hexagram(inner, outer))
